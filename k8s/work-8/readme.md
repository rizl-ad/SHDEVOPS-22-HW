# Решение ДЗ к занятию «Компоненты Kubernetes»

## Worker-ноды

### Кластер с тремя worker-нодами

При заданных условиях оптимальным количеством worker-нод представляется 3 ноды:
- предполагается, что в штатных условиях каждая worker-нода будет размещать на себе по одному экземпляру ДБ и кэш-сервиса, по 1-2 экземпляра frontend и по 3-4 экземпляра backend;
- наличие минимум трёх worker-нод позволит обеспечить отказоустойчивость при выходе одной из нод.

Расчет необходимых ресурсов для каждой worker-ноды производится следующим образом:
- CPU cores/vCPU = 1 для БД + 1 для кэш + (0,2 х 2) для frontend + (1 х 4) для backend = 6,4
- RAM в ГБ = 4 для БД + 4 для кэш + (0,049* х 2) для frontend + (0,586* х 4) для backend = 10,442
* Значения в МБ приведены к ГБ при условии 1 ГБ = 1024 МБ.

Получаем значения 6,4 core/vCPU и 10,442 ГБ RAM, а поскольку можно предоставить только целые и кратные 2 значения получаем 8 и 12, соответственно.

Далее к этим значениям следует прибавить ресурсы, потребляемые системными компонентами (ОС, kubelet, kube-proxy и пр.).   
Из статьи https://learnkube.com/kubernetes-node-size известны средние значения потребляемых системными компонентами ресурсов: 

1. CPU резервируется следующим образом:
- 6% от первого ядра;
- 1% от следующего ядра (до 2 ядер);
- 0,5% от следующих двух ядер (до 4);
- 0,25% от всех ядер, количество которых превышает четыре.

2. RAM резервируется следующим образом:
- 255 МБ для машин с объемом памяти менее 1 ГБ;
- 25% от первых 4 ГБ;
- 20% от следующих 4 ГБ (до 8 ГБ);
- 10% от следующих 8 ГБ (до 16 ГБ);
- 6% от следующих 112 ГБ (до 128 ГБ);
- 2% от объема свыше 128 ГБ.

3. Порог для выселения составляет 100 МБ (0,0977 ГБ).

Исходя из этих данных получаем:
- CPU cores/vCPU = 8 + 0,09 (6% + 1% + (2 х 0,5%) + (4 х 0,25%)) = 8,09
- RAM в ГБ = 12 + 2,2 ((4 x 25%) + (4 x 20%) + (4 x 10%)) + 0,0977 порог выселения  = 14,2977

Получаем значения 8,09 core/ vCPU и 14,2977 ГБ RAM, а поскольку можно предоставить только целые и кратные 2 значения получаем 10 и 16, соответственно.

Теперь представим, что одна worker-нода вышла из строя, в этом случае её нагрузка должна распределится по двум оставшимся. Но в текущей конфигурации нод (10 vCPU и 16 RAM каждая) распределить нагрузку не получится, т.к. на оставшихся нодах для этого недостаточно ресурсов.   
Для этих целей необходимо рассчитать ресурсы worker-нод для обеспечения HA при условии потери одной worker-ноды.   
Предполагается, что после выхода одной worker-ноды нагрузка распределится следующим образом: по 1-2 экземпляра ДБ и кэш-сервиса, по 2-3 экземпляра frontend и по 5 экземпляров backend.

Расчет необходимых ресурсов для каждой worker-ноды производится следующим образом:
- CPU cores/vCPU = (1 x 2) для БД + (1 x 2) для кэш + (0,2 х 3) для frontend + (1 х 5) для backend = 9,6
- RAM в ГБ = (4 x 2) для БД + (4 x 2) для кэш + (0,049* х 3) для frontend + (0,586* х 5) для backend = 19,077
* Значения в МБ приведены к ГБ при условии 1 ГБ = 1024 МБ.

Получаем значения 9,6 core/vCPU и 19,077 ГБ RAM, а поскольку можно предоставить только целые и кратные 2 значения получаем 10 и 20, соответственно.

Далее к этим значения следует прибавить ресурсы, потребляемые системными компонентами:
- CPU cores/vCPU = 10 + 0,095 (6% + 1% + (2 х 0,5%) + (6 х 0,25%)) = 10,095
- RAM в ГБ = 20 + 2,84 ((4 x 25%) + (4 x 20%) + (8 x 10%) + (4 * 6%)) + 0,0977 порог выселения  = 22,9377

Получаем значения 10,095 core/ vCPU и 22,9377 ГБ RAM, а поскольку можно предоставить только целые и кратные 2 значения получаем 12 и 24, соответственно.

Т.о. в кластере из трех worker-нод, каждая должна иметь 12 CPU cores/vCPU и 24 ГБ RAM.

### Сравнени с кластером с четырьмя worker-нодами

Теперь сравним данное решение с кластером из 4-ёх нод, где также допустим выход одной ноды из строя.   
На самом деле, ресурсы ноды для такой конфигурации мы уже рассчитали, когда считали ресурсы для кластера из 3-ёх нод без предположения выхода одной из строя. Но в отличии от той конфигурации нам понадобится 4 таких ноды.

Т.е. мы сравниваем кластеры:
- 3 worker-ноды по 12 CPU cores/vCPU и 24 ГБ RAM
- 4 worker-ноды по 10 CPU cores/vCPU и 16 ГБ RAM

Проведем сравнение с финансовой точки зрения на примере Yandex Cloud:
- 3 ноды 12 vCPU и 24 ГБ RAM – цена аренды на момент написания отчета 15 467,11 руб/мес, за три ноды = 15 467,11 x 3 = 46 401,33 руб/мес
- 4 ноды 10 vCPU и 16 ГБ RAM – на Yandex Cloud количество RAM должно быть кратно количеству vCPU, поэтому применяемая конфигурация будет иметь ресурсы 10 vCPU и 20 ГБ RAM - цена аренды на момент написания отчета 12 963,24 руб/мес, за четыре ноды = 12 963,24 x 4 = 51 852,96 руб/мес

Т.о., по крайней мере с финансовой точки зрения, конфигурация кластера c 3-мя worker-нодами является предпочтительной. Кроме того, без наличия вводных по нагрузке на БД и систему хранения, предполагаем, что два экземпляра БД на одной ноде (в случае выхода одной из строя) не приведут к негативным последствиям.

## Master-ноды

С worker-нодами разобрались, теперь немного о master-нодах.

Исходя из указанных нагрузок для обеспечения HA считаю достаточным минимальных трёх master-нод c размещенным на них etcd, и выделением следующих ресурсов на каждую ноду:
- 2 CPU cores/vCPU
- 4 ГБ RAM

## Итог

Итого, для НА решения описанной задачи потребуется:
- 3 master-ноды с 2 CPU cores/vCPU и 4 ГБ RAM на каждой
- 3 worker-ноды с 12 vCPU и 24 ГБ RAM на каждой
